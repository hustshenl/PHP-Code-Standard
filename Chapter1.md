# PHP编码规范

## 书写规范

`Pear` 编码规范是当前广泛采用的 PHP 编码标准，许多开源项目和开源框架的编码方案都与其大同小异 ， `Pear` 编码规范是当前广泛采用的 PHP 编码标准，许多开源项目和开源框架的编码方案都与其大同小异

### 一、缩进、换行、和文件编码

+ 使用`4`个空格缩进（必须强制使用空格来代替缩进符`<tab>`）
+ 使用 `unix` 换行符，不可使用 `windows` 和 `mac` 风格的
+ 使用 `utf8-无bom` 格式
+ 大家打开一个新文件或者创建一个新文件，首要检查该文件的文件编码以及换行符是否符合以上要求，如不符合应立即转换
    
### 二、空格使用规范

以下规范使用if做完示例，同样适用于其他关键字，大部分IDE的格式化功能会自动按照上述规范进行格式化

1. 在`if`关键字与条件式的左括号之间必须有一个空格，在条件式的右括号与中括号之间也要有一个空格

```php
    if空格()空格{}
```
    
2. 条件式的两个括号与条件式之间不能有空格

```php
   if空格(条件式)空格{}
```
3. 运算符两边应空格
```php
   if (condition1空格||空格condition2) {}
```    

### 三、控制结构
1. switch 语句
    + `case`应换行，并与`switch`对齐
    + `case`后不需要换行
    + `break`后应空一行
 
1. 长的if语句应该分多行
+ 运算符放到下一行开头，并四个空格缩进，第一个条件式应与下一行的条件式对齐
```php
    if (   $condition1
    || $condition2
    || $condition3
    ) {
    //code here
    }
```
    
+  当复合的条件式不够清晰时，应该将复合条件式独立出单独到单独的变量中。使得阅读者可以一眼看出条件表达式所要表达的意思
```php
    $is_foo = ($condition1 || $condition2);
    $is_bar = ($condition3 && $condtion4);
    if ($is_foo && $is_bar) {
    // ….
    }
```
这一条同样适用于三目运算符的条件式，当三目运算符的条件式比较复杂且不够清晰是，可以独立到单独的变量中
    
    
 ### 四、函数调用
 
1.  函数在被调用时，函数名与其左花括号之间不能有空格（对于花括号不换行的），函数参数与两个括号之间也不能有空格，但是后一个参数与前一个参数的逗号之间必须有一个空格，参数逗号与左边的参数不能有空格

 ```php
     $var = foo($bar, $baz, $quux);
 ```
 
2.  函数调用的对齐（这一条同样适用于所有的其他表达式）
 当有几行函数赋值的调用，那么被赋值的变量，应以等号对齐(太长的就不需要了，要适可而止，主要是为了清晰好看)
 
```php 
     $short         = foo($bar);
     $long_variable = foo($baz);
     
     $is_shame = ($condition1 || $condition2);           // sd fds f
     $is_girl      = ($condition3 && $condition4);       // dsfdsaf
```
 
3. 当函数参数过多时，应该分行，并对齐，第一个换行的参数应该以四个空格缩进，使阅读清晰
 
 ```php
     $this->someObject->subObject->callThisFunctionWithALongName(
     $parameterOne, $parameterTwo,
     $aVeryLongParameterThree
     );
```
  
 加强版

```php    
     $this->someObject->callThisFunctionWithALongName(
     $parameterOne,
     $parameterTwo,
     $aVeryLongParameterThree,
     $aVeryLong,
     $aVeryLong
     );
     
     $this->sObject->call($parameterOne,
     $parameterTwo,
     $aVeryLongParameterThree,
     $aVeryLong,
     $aVeryLong);
```
  
4. 函数的链式调用过多，应分行，第一个分行的方法应该以四个空格缩进

```php 
     $someObject->someFunction("some", "parameter")
     ->someOtherFunc(23, 42)
     ->andAThirdFunction();
```


### 五、类的定义与函数的定义

类的定义的花括号要换一行
```php
    class Foo_Bar
    {
    //… code goes here
    }
```
    
也有规范认为（例如magnto）：类和方法的花括号要换行，但是控制结构的语句，中括号不换行

关于花括号是否换行一直是一个争论性的话题，这里仅要求类的定义的花括号换一行。

### 六、注释

注释在`pear`里面没有规定其风格，但是他建议大家遵循一下的要求。

1. 按内容多少分为块注释和行注释
2. 按注释对象的类型分为文件注释、类注释、方法注释、变量（包括常量、静态变量等）、表达式注释
3. 注释要注意换行，一般以`80`个字符为一行，如果需要注释的内容超过一行，则最好使用块注释
4. 注意注释内容与注释符号之间的空格

+ 块注释：
```php
    /**
     * 注释内容，
     * 注释内容
     *
     */
```

+ 行注释：
```php
    /* 一般置于注释对象的上方 */
    // 一般置于注释对象的右侧
```

建议！：以后尽量不要使用 双杠注释//，都改为块注释/* */

### 七、php解析标签 <?php ?>
1. 不要使用简标签`<? ?>`，应使用长标签 `<?php ?>`
2. 纯PHP文件省略尾部`?>`，并插入一段注释来标明这是文件的底部并定位这个文件在这个应用的相对路径。这样有利于你确定这个文件已经结束而不是被删节的。


## 命名规范

### 通用说明

1. 所有变量，类名，函数，方法名称以及数组键值的命名应该有明确的含义，宜使用英文和专有名词进行表达，不宜使用汉语拼音，严禁使用非ASCII字符命名；
2. 大部分变量以及类名应该使用名词，函数和和方法使用动词或者动词加名词的组合形式
3. 类名和数据库表应使用名词单数形式。



### 元素命名

1. 常量全部大写，并且用下划线分割单词，常量甚至可以使用一句简单的话来命名

2. 各类型元素的命名遵循大小驼峰式命名法
    1. 类名采用大驼峰命名，即首字母大写
    2. 变量名称、方法名称使用小驼峰命名
    3. 私有变量、私有方法在小驼峰命名方法前增加`_`
```php
    private $_barFoo;
    private function _fooBar(){
    }
```
### 文件和目录命名

1. 目录或文件命名字符仅可用使用`[a-Z0-9._]`即忽略大小写后不得同名
    + 错误的命名
```shell
    /foo
    /Foo/
```
2. 目录命名下划线命名法，若框架有推荐命名方法则优先使用框架推荐命名方法，例如ThinkPHP目录使用大驼峰命名法
3. 类文件命名使用大驼峰命名法
4. 配置文件、函数文件、入口文件使用小驼峰命名法
5. README，CHANGELOG，LICENSE等文件名全部大写

## 性能建议

### 数组操作

PHP内置了很多数组操作方法，基本上能够解决80%的数组操作，代码编写中尽量使用这些方法，不要自行编写代码循环数组完成工作。

### 循环

1. 在执行for循环之前确定最大循环数，不要把 count/strlen/sizeof 等每次都要重复做的但结果都一样的事情放到 for 循环的条件语句中，另外最好运用foreach代替for循环。
2. 禁止在循环内查询数据库，应将查询放在循环外。
3. 循环内部不宜使用`@`操作符
4. 循环内部不宜声明变量，尤其是大变量：对象，解决办法是循环之前预定义需要声明的变量。


### 循环与递归

1. 递归算法：

    + 优点：代码简洁、清晰，并且容易验证正确性。（如果你真的理解了算法的话，否则你更晕）
    + 缺点：它的运行需要较多次数的函数调用，如果调用层数比较深，需要增加额外的堆栈处理（还有可能出现堆栈溢出的情况），比如参数传递需要压栈等操作，会对执行效率有一定影响。但是，对于某些问题，如果不使用递归，那将是极端难看的代码。

2. 循环算法：

    + 优点：速度快，结构简单。
    + 缺点：并不能解决所有的问题。有的问题适合使用递归而不是循环。

3. 递归算法和循环算法总结：
    1. 如果使用循环并不困难的话，最好使用循环。
    2. 如果递归层级不深的话，尽量使用递归。



## 安全建议


### 安全保护一般性要点

+ 不相信表单

    对于一般的Javascript前台验证，由于无法得知用户的行为，例如关闭了浏览器的javascript引擎，这样通过POST恶意数据到服务器。需要在服务器端进行验证，对每个php脚本验证传递到的数据，防止XSS攻击和SQL注入
  
+  不相信用户
  
    要假设你的网站接收的每一条数据都是存在恶意代码的，存在隐藏的威胁，要对每一条数据都进行清理
  
+ 关闭全局变量
    在PHP4.2开始, register_globals默认设置为了OFF.
    
    
### SQL注入

1. 定义
代码注入技术，利用一个安全漏洞，在应用程序的数据库层发生。该漏洞是存在的，当用户输入或者不正确的字符串文字转义字符中嵌入SQL语句或用户输入不强类型，从而意外地执行过滤。

2. 预防建议

+ 禁止使用字符串拼接构造SQL查询语句
+ 对查询参数的数据类型进行验证，对字符型查询参数过滤特殊字符
+ 使用预备义语句和参数化查询。对于带有任何参数的sql语句都会被发送到数据库服务器，并被解析！对于攻击者想要恶意注入sql是不可能的！
    + 使用PDO(PHP Data Objects )
```php
    $stmt = $pdo->prepare('SELECT * FROM employees WHERE name = :name');
    $stmt->execute(array(':name' => $name));
    foreach ($stmt as $row) {
        // do something with $row
    }
```
    + 使用mysqli
```php
    $stmt = $dbConnection->prepare('SELECT * FROM employees WHERE name = ?');
    $stmt->bind_param('s', $name);
    $stmt->execute();
    $result = $stmt->get_result();
    while ($row = $result->fetch_assoc()) {
        // do something with $row
    }
  ```

3. 案例 http://0day5.com/archives/1834/

> NOTE: ThinkPHP中Model使用字符串作为查询条件仅对字符串转义后拼接SQL语句，安全性较差；使用数组和对象方式查询则使用预备义语句和参数化查询，安全性较高

### 跨站脚本XSS

1. 定义
安全漏洞，通常在Web应用程序的其他用户浏览网页，它允许恶意web用户将代码注入。这样的例子：包括客户端脚本（即JavaScript）的。

2. 预防建议
    + 接收用户数据时将HTML实体转义
    + 显示用户提交数据时对HTML实体转义
    + 对外站链接进行二次跳转

### 跨站请求伪造CSRF
1. CSRF 顾名思义，是伪造请求，冒充用户在站内的正常操作。我们知道，绝大多数网站是通过 cookie 等方式辨识用户身份(包括使用服务器端 Session 的网站，因为 Session ID 也是大多保存在 cookie 里面的)，再予以授权的。所以要伪造用户的正常操作，最好的方法是通过 XSS 或链接欺骗等途径，让用户在本机(即拥有身份 cookie 的浏览器端)发起用户所不知道的请求。

    要完成一次CSRF攻击，受害者必须依次完成两个步骤：
    1. 登录受信任网站A，并在本地生成Cookie。
    2. 在不登出A的情况下，访问危险网站B。

2. 预防建议
    + 使用POST接收数据
    + 使用验证码或者Token来验证表单
    + 禁用跨域POST功能

### SESSION

1. 大部分系统会使用Session记录用户身份授权状态，Session信息依赖于用户Cookie，Cookie信息泄露同时会造成Session信息泄露；
2. 预防Session泄露建议
    + 会话完成后，及时销毁会话数据
    + 不要将Session文件保存在默认路径，保存到Web目录或者数据库
    + 读取Session时验证IP
    + 敏感操作二次验证密码


### 文件上传

文件上传漏洞一般可以从以下几个方面进行预防

1. 在数据操作前一定要对$_FILES进行验证，判断文件是否已经在 $_FILES 中 ；
2. 验证用户上传的文件类型、大小，为盖文件分配随机的名称，将文件真实信息保存在数据库
3. 将用户上传的文件保存到专门目录，并设置移除文件的执行权限
4. 不要执行用户上传的文件，或者用include require等包含用户上传的文件


## 其他

### 项目文件结构与版本管理

1. 项目文件应包含源代码，配置文件样例，项目文档，项目说明，变更日志，版权授权文件
```shell
    src/                        # 源代码
    doc/                        # 项目文档
    sample/                     # 配置文件样例
    README.md                   # 项目说明
    CHANGELOG.md                # 变更日志
    LICENSE                     # 版权授权
```
2. 项目配置文件应独立配置在一个或者几个文件中，这些配置文件应加入到`.gitignore`中，并将文件与目录结构复制到配置文件样例目录，便于运维部署。


## 
